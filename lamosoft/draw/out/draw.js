var abc = `ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789,.:+-*/!"`;

var bitfont1 = function( basic ) {

basic.defineLetter( 'A',`
        
   111  
  1   1 
 11    1
 11    1
 1111111
 11    1
 11    1
` );

basic.defineLetter( 'B',`
        
 11111  
 11   1 
 11   1 
 111111 
 11    1
 11    1
 111111 
` );

basic.defineLetter( 'C',`
        
  11111 
 11    1
 11     
 11     
 11     
 11    1
  11111 
` );

basic.defineLetter( 'D',`
        
 11111  
 11   1 
 11    1
 11    1
 11    1
 11    1
 111111 
` );

basic.defineLetter( 'E', `
                
 1111111
 11     
 11     
 111111 
 11     
 11     
 1111111
` );

basic.defineLetter( 'F', `
         
 1111111
 11     
 11     
 111111 
 11     
 11     
 11      
` );

basic.defineLetter( 'G', `
          
  11111  
 11    1 
 11      
 11 1111 
 11    1 
 11    1 
  11111   
` );

basic.defineLetter( 'H', `
         
 11    1
 11    1
 11    1
 1111111    
 11    1
 11    1
 11    1      
` );

basic.defineLetter( 'I', `
        
   1111  
    11 
    11 
    11 
    11 
    11 
   1111  
` );

basic.defineLetter( 'J', `
        
 111111    
     11  
     11  
     11  
     11  
 1   11  
  1111   
` );

basic.defineLetter( 'K', `
        
 11    1
 11   1 
 11  1  
 1111   
 11  1  
 11   1 
 11    1  
` );

basic.defineLetter( 'L', `
        
 11     
 11     
 11     
 11     
 11     
 11     
 1111111
` );

basic.defineLetter( 'M', `
        
 11    1
 111  11
 11 11 1
 11    1
 11    1
 11    1
 11    1
` );

basic.defineLetter( 'N', `
        
 11    1
 111   1
 1111  1
 11 11 1
 11  111
 11   11
 11    1
` );

basic.defineLetter( 'O',`
        
  11111 
 11    1
 11    1
 11    1
 11    1
 11    1
  11111 
` );

basic.defineLetter( 'P',`
        
 111111 
 11    1
 11    1
 111111 
 11     
 11     
 11     
` );

basic.defineLetter( 'Q',`
        
  11111 
 11    1
 11    1
 11    1
 11    1
 11  11
  111 11 
` );

basic.defineLetter( 'R',`
        
 111111 
 11    1
 11    1
 111111 
 11   1     
 11    1    
 11    1  
` );

basic.defineLetter( 'S',`
        
  11111 
 11    1
 11    
  11111   
      11      
 11   11    
  11111   
` );

basic.defineLetter( 'T', `
        
 111111 
   11     
   11    
   11   
   11   
   11   
   11    
` );

basic.defineLetter( 'U',`
        
 11    1 
 11    1
 11    1
 11    1
 11    1
 11    1
  11111 
` );

basic.defineLetter( 'V',`
        
 11    1
 11    1
  11  1 
  11  1 
   111  
   111  
    1   
` );

basic.defineLetter( 'W',`
        
 11    1
 11    1
 11    1
 11    1
 11    1
 11 11 1
  111 1  
` );

basic.defineLetter( 'X', `
        
 11    1
 11    1
  11  1 
   111  
  11  1 
 11    1
 11    1
` );

basic.defineLetter( 'Y', `
        
 11    1
 11    1
  11  1 
   111  
    11   
    11   
    11   
` );

basic.defineLetter( 'Z', `
        
 1111111
      11
     11 
    11  
   11   
  11    
 1111111   
` );

basic.defineLetter( '0', `
        
   111  
  11  1
 11    1
 11    1
 11    1
  11  1 
   111  
` );

basic.defineLetter( '1', `
        
   111  
 11 11  
    11  
    11  
    11  
    11  
    11  
` );

basic.defineLetter( '2', `
        
  11111  
 11   11  
      11
    11 
  11    
 11     
 1111111
` );

basic.defineLetter( '3', `
        
  11111 
 11   11
      11
    11  
      11
 11   11
  11111 
` );

basic.defineLetter( '4', `
        
    111
   1 11 
  1  11 
 1   11
 1111111  
     11
     11 
` );

basic.defineLetter( '5',`
        
 1111111
 11    
 11    
  11111   
      11      
 11   11    
  11111   
` );

basic.defineLetter( '6',`
        
  11111
 11     
 11    
 111111   
 11   11      
 11   11    
  11111   
` );

basic.defineLetter( '7',`
        
 1111111
      11     
     11    
    11  
   11   
  11    
 11     
` );

basic.defineLetter( '8',`
        
  11111 
 11    1    
 11    1
  11111
 11    1
 11    1
  11111
` );

basic.defineLetter( '9',`
        
  11111 
 11    1    
 11    1
  111111
       1
       1
  11111
` );

basic.defineLetter( '.',`
        
        
        
        
             
        
   11
   11
` );

basic.defineLetter( ',',`
        
        
        
    
        
        
    11   
   11    
` );

basic.defineLetter( '-',`
        
        
        
        
  11111



` );

basic.defineLetter( ' ',`
        
        
        
        
        
        
        
        
` );

basic.defineLetter( 'a',`
        
 
  
  11111    
       1
  111111
 11    1
  111111
` );

basic.defineLetter( 'b',`
        
 11   
 11  
 111111 
 11    1
 11    1
 11    1
 111111 
` );

basic.defineLetter( 'c',`
 
 
 
  11111 
 11    
 11     
 11    
  11111 
` );

basic.defineLetter( 'd',`
        
      11
      11 
  111111
 1    11
 1    11
 1    11
  111111 
` );

basic.defineLetter( 'e', `
                
 
      
  11111     
 11    1 
 1111111     
 11     
  111111
` );

basic.defineLetter( 'f', `
         
   1111
  11     
  11     
  1111 
  11     
  11     
  11      
` );

basic.defineLetter( 'g', `
             
 
 
  11111      
 1    11 
  111111 
      11 
 111111   
` );

basic.defineLetter( 'h', `
         
 11    
 11    
 11    
 111111    
 11    1
 11    1
 11    1      
` );

basic.defineLetter( 'j', `
   
  
    11  
     
   111 
    11 
    11 
   1111  
` );

basic.defineLetter( 'J', `
        
 111111    
     11  
     11  
     11  
     11  
 1   11  
  1111   
` );

basic.defineLetter( 'K', `
        
 11    1
 11   1 
 11  1  
 1111   
 11  1  
 11   1 
 11    1  
` );

basic.defineLetter( 'L', `
        
 11     
 11     
 11     
 11     
 11     
 11     
 1111111
` );

basic.defineLetter( 'M', `
        
 11    1
 111  11
 11 11 1
 11    1
 11    1
 11    1
 11    1
` );

basic.defineLetter( 'N', `
        
 11    1
 111   1
 1111  1
 11 11 1
 11  111
 11   11
 11    1
` );

basic.defineLetter( 'O',`
        
  11111 
 11    1
 11    1
 11    1
 11    1
 11    1
  11111 
` );

basic.defineLetter( 'P',`
        
 111111 
 11    1
 11    1
 111111 
 11     
 11     
 11     
` );

basic.defineLetter( 'Q',`
        
  11111 
 11    1
 11    1
 11    1
 11    1
 11  11
  111 11 
` );

basic.defineLetter( 'R',`
        
 111111 
 11    1
 11    1
 111111 
 11   1     
 11    1    
 11    1  
` );

basic.defineLetter( 'S',`
        
  11111 
 11    1
 11    
  11111   
      11      
 11   11    
  11111   
` );

basic.defineLetter( 'T', `
        
 111111 
   11     
   11    
   11   
   11   
   11   
   11    
` );

basic.defineLetter( 'U',`
        
 11    1 
 11    1
 11    1
 11    1
 11    1
 11    1
  11111 
` );

basic.defineLetter( 'V',`
        
 11    1
 11    1
  11  1 
  11  1 
   111  
   111  
    1   
` );

basic.defineLetter( 'W',`
        
 11    1
 11    1
 11    1
 11    1
 11    1
 11 11 1
  111 1  
` );

basic.defineLetter( 'X', `
        
 11    1
 11    1
  11  1 
   111  
  11  1 
 11    1
 11    1
` );

basic.defineLetter( 'Y', `
        
 11    1
 11    1
  11  1 
   111  
    11   
    11   
    11   
` );

basic.defineLetter( 'Z', `
        
 1111111
      11
     11 
    11  
   11   
  11    
 1111111   
` );

basic.defineLetter( '0', `
        
   111  
  11  1
 11    1
 11    1
 11    1
  11  1 
   111  
` );

basic.defineLetter( '1', `
        
   111  
 11 11  
    11  
    11  
    11  
    11  
    11  
` );

basic.defineLetter( '2', `
        
  11111  
 11   11  
      11
    11 
  11    
 11     
 1111111
` );

basic.defineLetter( '3', `
        
  11111 
 11   11
      11
    11  
      11
 11   11
  11111 
` );

basic.defineLetter( '4', `
        
    111
   1 11 
  1  11 
 1   11
 1111111  
     11
     11 
` );

basic.defineLetter( '5',`
        
 1111111
 11    
 11    
  11111   
      11      
 11   11    
  11111   
` );

basic.defineLetter( '6',`
        
  11111
 11     
 11    
 111111   
 11   11      
 11   11    
  11111   
` );

basic.defineLetter( '7',`
        
 1111111
      11     
     11    
    11  
   11   
  11    
 11     
` );

basic.defineLetter( '8',`
        
  11111 
 11    1    
 11    1
  11111
 11    1
 11    1
  11111
` );

basic.defineLetter( '9',`
        
  11111 
 11    1    
 11    1
  111111
       1
       1
  11111
` );

basic.defineLetter( '.',`
        
        
        
        
             
        
   11
   11
` );

basic.defineLetter( ',',`
        
        
        
    
        
        
    11   
   11    
` );

basic.defineLetter( '-',`
        
        
        
        
  11111



` );

basic.defineLetter( ' ',`
        
        
        
        
        
        
        
        
` );

};
var Bitscreen = function( ref, config ) {

    var me = this;
    me.canvas = new Canvas( ref );
    me.config = new Config( config, {
        width: me.canvas.el.width,
        height: me.canvas.el.height
    } );

    me.callbacks = {};

    me.pixelW = me.canvas.el.width / me.config.width;
    me.pixelH = me.canvas.el.height / me.config.height;


    me.setPixel = function( x, y, color ) {
        var me = this, c = me.canvas;
        c.setColor( color );
        x = x * me.pixelW;
        y = y * me.pixelH;
        c.rect( x, y, me.pixelW, me.pixelH );
    };

    me.clearPixel = function( x, y ) {
        var me = this, c = me.canvas;
        x = x * me.pixelW;
        y = y * me.pixelH;
        c.clear( x, y, me.pixelW, me.pixelH );
    };

    me.drawSprite = function( x, y, sprite, palette ) {
        var me = this;
        for( var j = 0; j < sprite.height(); j++ ) {
            for( var i = 0; i < sprite.width(); i++ ) {
                var c = sprite.get( i, j );
                if( c == ' ' ) {
                    me.clearPixel( x + i, y + j );
                }
                else {
                    var color = palette.get( c );
                    me.setPixel( x + i, y + j, color );
                }
            }
        }
    };

    me.callback = function( eventName, callback ) {

        var me = this;
        me.callbacks[ eventName ] = callback;

        me.canvas.callback( eventName, function( x, y ) {
            me.callbacks[ eventName ]( Math.floor( x / me.pixelW ), Math.floor( y / me.pixelH ) );
        });

    };

};



var Canvas = function( ref, config ) {

    var me = this;
    me.el = typeof ref == 'string' ? document.getElementById( ref ) : ref;
    me.ctx = me.el.getContext( '2d' );
    me.callbacks = {};
    me.config = new Config( config, {
        clear: false,
        color: 'black',
        width: 1
    });

    me.setMode = function( config ) {
        var me = this;
        var c = me.config;
        c.clear = config.clear != undefined ? config.clear : c.clear;
        c.color = config.color || c.color;
        c.width = config.width || c.width;
    };

    me.setClear = function( clear ) {
        me.setMode( { clear: clear } );
    };

    me.setColor = function( color ) {
        me.setMode( { color: color } );
    };

    me.setWidth = function( width ) {
        me.setMode( { width: width } );
    };

    me.line = function( x1, y1, x2, y2 ) {
        var me = this;
        me.ctx.moveTo( x1, y1 );
        me.ctx.lineTo( x2, y2 );
        me.ctx.stroke();
    };

    me.rect = function( x, y, w, h ) {
        var me = this;
        me.ctx.fillStyle = me.config.color;
        me.ctx.fillRect( x, y, w, h );
    };

    me.clear = function( x, y, w, h ) {
        var me = this;
        x = x || 0;
        y = y || 0;
        w = w || me.el.width;
        h = h || me.el.height;
        me.ctx.clearRect( x, y, w, h );
    };

    me.circle = function( x, y, r ) {
        var me = this;
        me.ctx.save();
        me.ctx.strokeStyle = me.config.color;
        me.ctx.lineWidth = me.config.width;
        me.ctx.beginPath();
        me.ctx.arc( x, y, r, 0, 2 * Math.PI );
        me.ctx.stroke();
        me.ctx.restore();
    };

    me.pie = function( x, y, r, start, end ) {
        var me = this;

        me.ctx.save();

        if( me.config.clear ) {
            me.ctx.globalCompositeOperation = 'destination-out';
        }

        me.ctx.fillStyle = me.config.color;

        start = start ? ( start / 360 ) * 2 * Math.PI : 0;
        end = end ? ( end / 360 ) * 2 * Math.PI : 2 * Math.PI;
        me.ctx.beginPath();
        me.ctx.moveTo( x, y );
        me.ctx.arc( x, y, r, start, end );
        me.ctx.closePath();
        me.ctx.fill();
        
        me.ctx.restore();

    };

    me.callback = function( eventName, callback ) {

        var me = this;
        me.callbacks[ eventName ] = callback;
        
        me.el.addEventListener( eventName, function( event ) {
            let x = event.offsetX;
            let y = event.offsetY;
            me.callbacks[ eventName ]( x, y );
        });

    };

};




(function() {

    var Config = function( config, defaults ) {

        var me = this;

        defaults = defaults || {};

        if( config ) {
            for( var parameter in config ) {
                me[ parameter ] = config[ parameter ] || defaults[ parameter ];
            }
        }

        if( defaults ) {
            for( var defaultParameter in defaults ) {
                if( !me[ defaultParameter ] ) {
                    me[ defaultParameter ] = defaults[ defaultParameter ];
                }
            }
        }

    };

    if (typeof module !== 'undefined' && typeof module.exports !== 'undefined')
        module.exports = Config;
    else
        window.Config = Config;

})();

var lorem = `Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy 
eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. 
At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, 
no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, 
consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore 
magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo 
dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem 
ipsum dolor sit amet.`;
/**
 * @module Matrix
 */
(function() {

    /**
     * Two dimensional Matrix of characters which each symbolizes a pixel in a sprite
     * 
     * @class Matrix
     * @param {*} w Width of matrix
     * @param {*} h Height of matrix
     * @param {*} preFillChar Character to fill all matrix positions at beginning
     * 
     */
    var Matrix = function( w, h, preFillChar ) {

        var me = this;

        /**
         * Fill all matrix positions with the preFillChar
         * 
         */
        me.clear = function() {
            var me = this;
            me.data = [ h ];
            for( var i = 0; i < h; i++ ) {
                me.data[ i ] = preFillChar.repeat( w );
            }
            return me;
        };
        
        /**
         * Set a matrix position
         * 
         * @param {*} x X coordinate
         * @param {*} y Y coordinate
         * @param {*} char New character at position x,y
         */
        me.set = function( x, y, char ) {
            var me = this;
            if( x >= 0 && y >= 0 && x < me.w && y < me.h ) {
                me.data[ y ] = me.data[ y ].slice( 0, x ) + char[ 0 ] + me.data[ y ].slice( x+1 );
            }
        };
        
        /**
         * Get character a position x,y
         * 
         * @param {*} x X coordinate
         * @param {*} y Y coordinate
         * @returns Character at position
         * 
         */
        me.get = function( x, y ) {
            var me = this;
            if( x >= 0 && y >= 0 && x < me.w && y < me.h ) {
                return me.data[ y ][ x ];
            }
            return null;
        };
        
        /**
         * Debug output of matrix
         * 
         * @returns Debug output as string
         * 
         */
        me.toString = function() {
            var me = this;
            var s = '', sep = '';
            for( var i = 0; i < h; i++ ) {
                s += sep + me.data[ i ];
                sep = '\n';
            }
            return s;
        };

        me.w = w;
        me.h = h;
        preFillChar = preFillChar || ' ';
        preFillChar = preFillChar[ 0 ];
        me.clear();

    };


    if (typeof module !== 'undefined' && typeof module.exports !== 'undefined')
        module.exports = Matrix;
    else
        window.Matrix = Matrix;

})();



(function() {

    /**
     * Palette
     * 
     * @param {*} colors Optional initialization with colors: array of map of char<>color
     */
    var Palette = function( colors ) {

        var me = this;
        me.colors = {};
        me.len = undefined;

        me.set = function( code, color ) {
            var me = this;
            code = me.checkCode( code );
            me.colors[ code ] = color;
            me.length = undefined;
        };
        
        me.get = function( code ) {
            var me = this;
            code = me.checkCode( code );
            var color = me.colors[ code ];
            return color || null;
        };
        
        me.getCode = function( index ) {
            return Palette.CODES[ index ];
        };
        
        me.length = function() {
            var me = this;
            if( !me.len ) {
                var i = 0;
                for( var code in colors ) {
                    i++;
                }
                me.len = i;
            }
            return me.len;
        };

        me.toString = function() {
            return '' + colors;
        };

        me.checkCode = function( code ) {
            var me = this;
            code = code[ 0 ];
            if( ( code >= 'A' && code <= 'Z' ) || ( code >= 'a' && code <= 'z' ) ) {
                    return code;
            }
            throw "Invalid color index code: '" + code + "'. Allowed are A-Z,a-z";
        };

        if( colors ) {
            if( Array.isArray( colors ) ) {
                for( var i = 0; i < colors.length && i < Palette.CODES.length; i++ ) {
                    me.colors[ Palette.CODES[ i ] ] = colors[ i ];
                }
            }
            else {
                for( var code in colors ) {
                    me.set( code, colors[ code ] );
                }
            }
        }

    };

    Palette.CODES = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
    Palette.C64 = new Palette([ '#000000', '#ffffff', '#880000', '#aaffee', '#cc44cc', '#00cc55', '#0000aa', '#eeee77', '#dd8855', '#664400', '#ff7777', '#333333', '#777777', '#aaff66', '#0088ff', '#bbbbbb' ]);

    if (typeof module !== 'undefined' && typeof module.exports !== 'undefined')
        module.exports = Palette;
    else
        window.Palette = Palette;

})();

/**
 * Pick color from a palette
 * 
 */
(function() {

    var Palettepicker = function( ref, palette, callback ) {

        var me = this;
        me.palette = palette;
        me.callback = callback;
        me.bitscreen = new Bitscreen( ref, { width: palette.length(), height: 1 });

        for( var i = 0; i < palette.length(); i++ ) {
            me.bitscreen.setPixel( i, 0, palette.get( palette.getCode( i ) ) );
        }

        me.bitscreen.callback( 'click', function( x, y ) {
            me.callback( me.palette.getCode( x ) );
        });

    };


    if (typeof module !== 'undefined' && typeof module.exports !== 'undefined')
        module.exports = Palettepicker;
    else
        window.Palettepicker = Palettepicker;

})();



/**
 * Sprite editor
 * 
 * @param {*} ref 
 * @param {*} config 
 * 
 */
var Spreditor = function( ref, config ) {

    var me = this;
    me.config = new Config( config, { width: 16, height: 16, palette: Palette.C64 } );
    me.palette = me.config.palette;
    me.bitscreen = new Bitscreen( ref, me.config );
    me.sprite = new Sprite( me.config );
    me.colorCode = me.palette.getCode( 0 );
    me.pendown = false;

    /**
     * Redraw sprite
     */
    me.update = function() {
        var me = this;
        me.bitscreen.drawSprite( 0, 0, me.sprite, me.palette );
        if( me.config.onUpdate ) {
            me.config.onUpdate( me );
        }
    }

    me.setColor = function( colorCode ) {
        var me = this;
        me.colorCode = colorCode;
    }

    me.bitscreen.callback( 'click', function( x, y ) {
        me.sprite.set( x, y, me.colorCode );
        me.update();
    });

    me.bitscreen.callback( 'mousedown', function( x, y ) {
        me.pendown = true;
        me.bitscreen.canvas.el.setAttribute( 'style', 'border: 1px solid gray;' );
    });
    
    me.bitscreen.callback( 'mouseup', function( x, y ) {
        me.pendown = false;
        me.bitscreen.canvas.el.setAttribute( 'style', 'border: 1px solid white;' );
    });
    
    me.bitscreen.callback( 'mousemove', function( x, y ) {
        if( me.pendown ) {
            me.sprite.set( x, y, me.colorCode );
            me.update();
        }
    });

    me.update();

};


var Sprite = function( config ) {

    var me = this;
    me.config = new Config( config, {
        width: 16,
        height: 16
    });

    me.matrix = me.config.matrix || new Matrix( me.config.width, me.config.height );

    me.clear = function() {
        var me = this;
        me.matrix.clear();
    };

    me.get = function( x, y ) {
        var me = this;
        return me.matrix.get( x, y );
    };

    me.set = function( x, y, c ) {
        var me = this;
        me.matrix.set( x, y, c );
    };

    me.width = function() {
        var me = this;
        return me.matrix.w;
    };

    me.height = function() {
        var me = this;
        return me.matrix.h;
    };

    me.toString = function() {
        var me = this;
        return me.matrix.toString();
    };   

};


/**
 * Class stub
 * 
 */
(function() {

    var Stub = function( parameters, config ) {

        var me = this;
        me.config = new Config( config, { /* defaultParameters */ } );

        me.f = function() {
            var me = this;
            // ...
            return 0;
        };
        
        // late constructor code
        // ...

    };


    if (typeof module !== 'undefined' && typeof module.exports !== 'undefined')
        module.exports = Stub;
    else
        window.Stub = Stub;

})();


